//@version=6
// インジケーター名: 「EMA + 一目均衡表 + BB（インジケーター）」
// 
// 概要:
// 本インジケーターは、複数の指数移動平均（EMA）とローソク足パターン「包み線」を用いた売買シグナルを提供します。
// 
// 主な機能:
// - 5本のEMA（5, 25, 50, 100, 200）をプロット
// - EMA5とEMA25のクロスによる売買シグナルを表示
//   ・買い：EMA5が25を上抜け ＋ 価格が雲の下
//   ・売り：EMA5が25を下抜け ＋ 価格が雲の上
// - ボリンジャーバンドを表示（中心線、上下バンド）
// - 出来高が急騰したときにシグナル（●）を表示
// - 一目均衡表を表示

indicator('EMA + 一目均衡表 + BB', overlay = true)

// ===== library import =====
import ise0615/EMA_Ichimoku_BB_Function/2 as lib

// パラメーター設定
src = input.source(close, "元データ")

// EMA期間設定
grp_ema = "EMA 設定"
ema_len1 = input.int(5,   "EMA 1", minval=1, group=grp_ema)
ema_len2 = input.int(25,  "EMA 2", minval=1, group=grp_ema)
ema_len3 = input.int(50,  "EMA 3", minval=1, group=grp_ema)
ema_len4 = input.int(100, "EMA 4", minval=1, group=grp_ema)
ema_len5 = input.int(200, "EMA 5", minval=1, group=grp_ema)

// ボリンジャーバンド設定
grp_bb = "ボリンジャーバンド 設定"
bb_len  = input.int(20,    "BB 期間", minval=1, group=grp_bb)
bb_mult = input.float(2.0, "BB 標準偏差", minval=0.1, step=0.1, group=grp_bb)

// 一目均衡表設定
grp_ichi = "一目均衡表 設定"
ichi_tenkan = input.int(9,  "転換線 期間", minval=1, group=grp_ichi)
ichi_kijun  = input.int(26, "基準線 期間", minval=1, group=grp_ichi)
ichi_senkou = input.int(52, "先行スパンB 期間", minval=1, group=grp_ichi)
ichi_disp   = input.int(26, "先行スパン変位 (Offset)", minval=1, group=grp_ichi)

// ライブラリ計算の実行
res = lib.calc(src, ema_len1, ema_len2, ema_len3, ema_len4, ema_len5, bb_len, bb_mult, ichi_tenkan, ichi_kijun, ichi_senkou, ichi_disp)

// ==============================
// チャートプロット
// ==============================

// EMA
plot(res.ema5, color = color.white,  title = 'ema5', linewidth = 1, display = display.none)
plot(res.ema25, color = color.green,  title = 'ema25', linewidth = 1)
plot(res.ema50, color = color.yellow, title = 'ema50', linewidth = 2)
plot(res.ema100, color = color.orange,    title = 'ema100', linewidth = 2)
plot(res.ema200, color = color.red, title = 'ema200', linewidth = 2)

// ボリンジャーバンド
plot(res.bbBasis, color = color.gray, title = 'BB Basis', display = display.none)
p_upper = plot(res.bbUpper, color = color.new(color.gray, 50), title = 'BB Upper', linewidth = 4)
p_lower = plot(res.bbLower, color = color.new(color.gray, 50), title = 'BB Lower', linewidth = 4)

// 一目均衡表
disp = 26
plot(res.tenkan, color = color.blue, title = '転換線', display = display.none)
plot(res.kijun, color = color.purple, title = '基準線', display = display.none)
p_senkouA = plot(res.senkouA, offset = disp, color = color.teal, title = '先行スパン1')
p_senkouB = plot(res.senkouB, offset = disp, color = color.maroon, title = '先行スパン2')
plot(close, offset = -disp, color = color.gray, title = '遅行スパン', display = display.none)
fill(p_senkouA, p_senkouB, color = res.senkouA > res.senkouB ? color.new(color.green, 90) : color.new(color.red, 90), title = '一目雲')


// シグナル表示
plotshape(res.emaBuy,  title = 'EMAクロス買い', location = location.belowbar, color = color.lime, style = shape.labelup, text = '買', textcolor = color.black)
plotshape(res.emaSell, title = 'EMAクロス売り', location = location.abovebar, color = color.red, style = shape.labeldown, text = '売', textcolor = color.white)
plotshape(res.bullishEngulfing, title = '包み線買い', location = location.belowbar, color = color.green, style = shape.triangleup, text = '包買')
plotshape(res.bearishEngulfing, title = '包み線売り', location = location.abovebar, color = color.red, style = shape.triangledown, text = '包売')
plotshape(res.volSpike, title = '出来高急騰', location = location.belowbar, style = shape.circle, size = size.tiny, color = color.fuchsia)

// === 通知機能 (alert関数) ===
// 買いシグナル
if res.emaBuy
    alert("【EMA】ゴールデンクロス発生 (" + syminfo.ticker + ")", alert.freq_once_per_bar_close)

if res.bullishEngulfing
    alert("【包み線】強気サイン発生 (" + syminfo.ticker + ")", alert.freq_once_per_bar_close)

// 売りシグナル
if res.emaSell
    alert("【EMA】デッドクロス発生 (" + syminfo.ticker + ")", alert.freq_once_per_bar_close)

if res.bearishEngulfing
    alert("【包み線】弱気サイン発生 (" + syminfo.ticker + ")", alert.freq_once_per_bar_close)

// 出来高急騰（オプション）
if res.volSpike
    alert("【出来高】急騰検知 (" + syminfo.ticker + ")", alert.freq_once_per_bar_close)
