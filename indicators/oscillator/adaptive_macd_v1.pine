//@version=6
// インジケーター名: 「可変MACDインジケーター」
// 
// 概要:
// 本インジケーターは、相場のボラティリティに応じて2種類のMACD（通常・高感度）を動的に切り替える「可変型MACD」です。
// ボリンジャーバンドの幅を検出し、高感度MACDへの切り替えを自動で行います。
//
// 主な機能:
// - 通常のMACDと、高感度設定のMACDを定義
// - ボリンジャーバンド幅（基準線の10%増）を検出し、MACDを高感度版に切り替え
// - 可変MACDライン、シグナルライン、ヒストグラムをチャートにプロット
// - MACDとシグナルのクロスによる売買シグナル表示（アラート対応）
// 
// 利用目的:
// 通常時はノイズを抑えたMACDでトレンドを捉えつつ、相場が急変した際には素早く反応できるよう自動で高感度モードに切り替え、タイミングの良いエントリー/エグジット判断を支援します。
//
// エントリー方法:
// 可変MACDラインがゼロラインより上の場合はロング推奨
// 可変MACDラインがゼロラインより下の場合はショート推奨

indicator('可変MACDインジケーター', overlay = false)

// === 入力パラメータ ===
src = input.source(close, title = '元データ')

// 通常MACD
fastLength = input.int(12, minval = 1, title = 'MACD 短期 EMA（通常）')
slowLength = input.int(26, minval = 1, title = 'MACD 長期 EMA（通常）')
signalSmoothing = input.int(9, minval = 1, title = 'MACD シグナル平滑化（通常）')

// 高感度MACD
fastLength_fast = input.int(6, minval = 1, title = 'MACD 短期 EMA（高感度）')
slowLength_fast = input.int(13, minval = 1, title = 'MACD 長期 EMA（高感度）')
signalSmoothing_fast = input.int(5, minval = 1, title = 'MACD シグナル平滑化（高感度）')

// ボリンジャーバンド設定
bbLength = input.int(20, title = 'ボリンジャーバンド期間')
bbMult = input.float(2.0, title = 'BB標準偏差倍率')
bbWidthThreshold = input.float(0.1, title = 'BB幅の閾値（基準線の何倍か）') // 0.1 = 10%

// === BB幅による切り替え判定 ===
bbBasis = ta.sma(src, bbLength)
bbStd = ta.stdev(src, bbLength)
bbUpper = bbBasis + bbMult * bbStd
bbLower = bbBasis - bbMult * bbStd
bbWidth = bbUpper - bbLower
bbWidthRatio = bbWidth / bbBasis // 基準線比の相対幅
useFastMACD = bbWidthRatio > bbWidthThreshold

// === MACD（通常）===
fastMA_normal = ta.ema(src, fastLength)
slowMA_normal = ta.ema(src, slowLength)
macd_normal = fastMA_normal - slowMA_normal
signal_normal = ta.ema(macd_normal, signalSmoothing)
hist_normal = macd_normal - signal_normal

// === MACD（高感度）===
fastMA_fast = ta.ema(src, fastLength_fast)
slowMA_fast = ta.ema(src, slowLength_fast)
macd_fast = fastMA_fast - slowMA_fast
signal_fast = ta.ema(macd_fast, signalSmoothing_fast)
hist_fast = macd_fast - signal_fast

// === 切り替えによるMACD最終値 ===
macd_final = useFastMACD ? macd_fast : macd_normal
signal_final = useFastMACD ? signal_fast : signal_normal
hist_final = macd_final - signal_final

// === 売買シグナル ===
bullishCross = ta.crossover(macd_final, signal_final)
bearishCross = ta.crossunder(macd_final, signal_final)

// === プロット ===
plot(macd_final, title = '可変MACD', color = color.orange, linewidth = 1)
plot(signal_final, title = 'シグナル', color = color.teal, linewidth = 1)
plot(hist_final, title = 'ヒストグラム', style = plot.style_columns, color = hist_final >= 0 ? color.new(color.lime, 30) : color.new(color.red, 30))

// === RSI 背景色追加（強弱を濃さで表現, 基準40・60） ===
rsiLength = input.int(14, title = 'RSI期間')
rsi = ta.rsi(src, rsiLength)

// RSI が 0 ～ 40 の範囲で強さを算出
lowStrength = math.max(0, (40 - rsi) / 40) // 0～1
// RSI が 60 ～ 100 の範囲で強さを算出
highStrength = math.max(0, (rsi - 60) / 40) // 0～1

// 強さに応じて透明度を計算（0=不透明、90=かなり薄い）
lowTransp = 90 - lowStrength * 90
highTransp = 90 - highStrength * 90

// 背景色プロット
bgcolor(rsi <= 40 ? color.new(color.red, lowTransp) : na)
bgcolor(rsi >= 60 ? color.new(color.green, highTransp) : na)

// === アラート ===
alertcondition(bullishCross, title = '買いシグナル発生', message = '【可変MACD】買いシグナル発生')
alertcondition(bearishCross, title = '売りシグナル発生', message = '【可変MACD】売りシグナル発生')
