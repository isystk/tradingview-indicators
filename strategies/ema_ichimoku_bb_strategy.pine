//@version=6
// インジケーター名: 「可変MACD（ストラテジー）」
// 
// 概要:
// 相場のボラティリティ（BB幅）の変化に応じて、標準的なMACD設定と、初動を捉えるための高感度設定を
// 動的に合成（ブレンド）して表示する適応型インジケーターです。
// ボラティリティ上昇時には高感度モードへの重みが増し、トレンド転換を早期に視覚化します。
//
// 主な機能:
// - デュアル計算エンジン: 通常設定と高感度設定のMACDをバックグラウンドで同時計算。
// - 適応型ブレンド: BB幅の閾値に基づき、2つのMACDの結果を線形補間で滑らかに結合。
// - ダイナミックRSI背景: 40以下/60以上の過熱領域において、端に近づくほど色が濃くなるグラデーション背景。
// - スマートアラート: 合成後のMACDラインとシグナルのクロスを検知し、銘柄名付きで通知。

strategy('可変MACD（ストラテジー）', overlay = false, initial_capital = 1000000, default_qty_type = strategy .percent_of_equity, default_qty_value = 20)

import ise0615/Adaptive_Mac_Function/1 as lib

// ==============================
// 入力パラメータ
// ==============================
src = input.source(close, title = '元データ')

grp_mac_n = "通常MACD 設定"
f_n = input.int(12, "通常短期", group=grp_mac_n)
s_n = input.int(26, "通常長期", group=grp_mac_n)
sig_n = input.int(9, "通常シグナル", group=grp_mac_n)

grp_mac_f = "高感度MACD 設定"
f_f = input.int(6, "高感度短期", group=grp_mac_f)
s_f = input.int(13, "高感度長期", group=grp_mac_f)
sig_f = input.int(5, "高感度シグナル", group=grp_mac_f)

grp_bb = "BB 設定"
bbL = input.int(20, "BB期間", group=grp_bb)
bbM = input.float(2.0, "BB偏差", group=grp_bb)
bbThr = input.float(0.1, "移行閾値", group=grp_bb)

grp_exit = "利確・損切 設定"
useExit  = input.bool(true, "利確・損切を使用する", group=grp_exit)
tpPerc   = input.float(3.0, "利確 (Take Profit %)", minval=0.0, step=0.1, group=grp_exit) / 100
slPerc   = input.float(1.5, "損切 (Stop Loss %)", minval=0.0, step=0.1, group=grp_exit) / 100

// 計算呼び出し
res = lib.calc(src, f_n, s_n, sig_n, f_f, s_f, sig_f, bbL, bbM, bbThr)

// ==============================
// チャートプロット
// ==============================

plot(res.macd, '可変MACD', color.orange, 2)
plot(res.signal, 'シグナル', color.teal, 1)
plot(res.hist, 'ヒストグラム', style=plot.style_columns, color=res.hist >= 0 ? color.new(color.lime, 30) : color.new(color.red, 30))

// ==============================
// エントリーロジック
// ==============================

// 買いシグナル
if res.bullishCross
    strategy.entry("Long", strategy.long, comment="MACD Cross Up")

// 売りシグナル
if res.bearishCross
    strategy.entry("Short", strategy.short, comment="MACD Cross Down")

// ==============================
// 決済ロジック
// ==============================

if useExit
    // ロングポジションの決済
    strategy.exit("Exit Long", "Long", 
                 limit = strategy.position_avg_price * (1 + tpPerc), 
                 stop  = strategy.position_avg_price * (1 - slPerc),
                 comment_loss = "SL Long", comment_profit = "TP Long")
    
    // ショートポジションの決済
    strategy.exit("Exit Short", "Short", 
                 limit = strategy.position_avg_price * (1 - tpPerc), 
                 stop  = strategy.position_avg_price * (1 + slPerc),
                 comment_loss = "SL Short", comment_profit = "TP Short")
