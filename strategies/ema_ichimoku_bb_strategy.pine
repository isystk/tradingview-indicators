//@version=6
// インジケーター名: 「EMA + 一目均衡表 + BB（ストラテジー）」
// 
// 概要:
// 本インジケーターは、複数の指数移動平均（EMA）とローソク足パターン「包み線」を用いた売買シグナルを提供します。
// 
// 主な機能:
// - 5本のEMA（5, 25, 50, 100, 200）をプロット
// - EMA5とEMA25のクロスによる売買シグナルを表示
//   ・買い：EMA5が25を上抜け ＋ 価格が雲の下
//   ・売り：EMA5が25を下抜け ＋ 価格が雲の上
// - ボリンジャーバンドを表示（中心線、上下バンド）
// - 出来高が急騰したときにシグナル（●）を表示
// - 一目均衡表を表示

strategy('EMA + 一目均衡表 + BB（ストラテジー）', overlay = true, initial_capital = 1000000, default_qty_type = strategy .percent_of_equity, default_qty_value = 100)

// ===== library import =====
import ise0615/EMA_Ichimoku_BB_Function/2 as lib

// パラメーター設定
src = input.source(close, "元データ")

// EMA期間設定
grp_ema = "EMA 設定"
ema_len1 = input.int(5,   "EMA 1", minval=1, group=grp_ema)
ema_len2 = input.int(25,  "EMA 2", minval=1, group=grp_ema)
ema_len3 = input.int(50,  "EMA 3", minval=1, group=grp_ema)
ema_len4 = input.int(100, "EMA 4", minval=1, group=grp_ema)
ema_len5 = input.int(200, "EMA 5", minval=1, group=grp_ema)

// ボリンジャーバンド設定
grp_bb = "ボリンジャーバンド 設定"
bb_len  = input.int(20,    "BB 期間", minval=1, group=grp_bb)
bb_mult = input.float(2.0, "BB 標準偏差", minval=0.1, step=0.1, group=grp_bb)

// 一目均衡表設定
grp_ichi = "一目均衡表 設定"
ichi_tenkan = input.int(9,  "転換線 期間", minval=1, group=grp_ichi)
ichi_kijun  = input.int(26, "基準線 期間", minval=1, group=grp_ichi)
ichi_senkou = input.int(52, "先行スパンB 期間", minval=1, group=grp_ichi)
ichi_disp   = input.int(26, "先行スパン変位 (Offset)", minval=1, group=grp_ichi)

// ライブラリ計算の実行
res = lib.calc(src, ema_len1, ema_len2, ema_len3, ema_len4, ema_len5, bb_len, bb_mult, ichi_tenkan, ichi_kijun, ichi_senkou, ichi_disp)

// ==============================
// ストラテジー（半値戻し指値エントリー）
// ==============================

// 買いシグナル：点灯した足の「高値と安値の真ん中」に指値を置く
if res.emaBuy
    float halfPriceLong = (high + low) / 2
    strategy.entry("Long", strategy.long, limit = halfPriceLong)

// 売りシグナル：点灯した足の「高値と安値の真ん中」に指値を置く
if res.emaSell
    float halfPriceShort = (high + low) / 2
    strategy.entry("Short", strategy.short, limit = halfPriceShort)


// ==============================
// 利確・損切設定
// ==============================

// 比率の設定（0.05 = 2%, 0.10 = 5%）
stopLossPercent   = 0.02
takeProfitPercent = 0.05

// 買いポジションの決済条件
if strategy.position_size > 0
    float longStopPrice   = strategy.position_avg_price * (1 - stopLossPercent)
    float longProfitPrice = strategy.position_avg_price * (1 + takeProfitPercent)
    strategy.exit("Long Exit", "Long", stop = longStopPrice, limit = longProfitPrice)

// 売りポジションの決済条件
if strategy.position_size < 0
    float shortStopPrice   = strategy.position_avg_price * (1 + stopLossPercent)
    float shortProfitPrice = strategy.position_avg_price * (1 - takeProfitPercent)
    strategy.exit("Short Exit", "Short", stop = shortStopPrice, limit = shortProfitPrice)
